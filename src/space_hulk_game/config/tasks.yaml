# Space Hulk Game - Task Definitions
#
# This file defines the tasks executed by the CrewAI agents to generate a complete game.
#
# ## Task Execution Flow
#
# ### Sequential Mode (Default)
# Tasks execute in the order they are defined and instantiated in crew.py:
# 1. GenerateOverarchingPlot -> 2. CreateNarrativeMap -> 3. DesignArtifactsAndPuzzles
# 4. WriteSceneDescriptionsAndDialogue -> 5. CreateGameMechanicsPRD
# Plus evaluation tasks: EvaluateNarrativeFoundation, EvaluateNarrativeStructure,
# NarrativeIntegrationCheckPuzzles, NarrativeIntegrationCheckScenes,
# NarrativeIntegrationCheckMechanics, FinalNarrativeIntegration
#
# ### Hierarchical Mode (Advanced)
# The NarrativeDirectorAgent manages task delegation and ensures quality.
# Tasks are delegated based on dependencies and agent specialization.
#
# ## Task Configuration Best Practices
#
# ### Context vs Dependencies
# - **context**: Provides information from previous tasks (read-only access to outputs)
# - **dependencies**: Enforces execution order (task X must complete before task Y)
#
# ### Avoiding Deadlocks
# - Keep dependency chains simple and linear where possible
# - Avoid circular dependencies (A depends on B, B depends on A)
# - In hierarchical mode, evaluation tasks should not create complex dependency webs
#
# ### Task Structure
# Each task includes:
# - name: Human-readable task name
# - description: Clear instructions for the agent
# - expected_output: Specific format and content requirements
# - agent: Agent responsible for executing the task
# - context: Previous task outputs to reference (optional)
# - dependencies: Tasks that must complete first (optional)
# - output_file: File to save task output (optional)
#
# ## Simplified Task Flow for Phase 0 Testing
#
# For initial validation (per REVISED_RESTART_PLAN.md), test with just the 5 core tasks:
# 1. GenerateOverarchingPlot
# 2. CreateNarrativeMap
# 3. DesignArtifactsAndPuzzles
# 4. WriteSceneDescriptionsAndDialogue
# 5. CreateGameMechanicsPRD
#
# Then incrementally add evaluation tasks one at a time to identify hanging points.

# Initial narrative foundation - must be completed and approved first
GenerateOverarchingPlot:
  name: "Generate Comprehensive Narrative Foundation"
  description: >
    Create a comprehensive narrative foundation for the Space Hulk game. This foundation must be
    detailed enough to guide all subsequent development, establishing the setting, key plot points,
    themes, tone, and central conflicts. This narrative foundation is the critical first step that
    all other development will build upon.

    **IMPORTANT: Output must be in valid JSON format with the following structure:**
    ```json
    {{
      "narrative_foundation": {{
        "title": "Game Title",
        "setting": "Detailed setting description",
        "themes": ["theme1", "theme2"],
        "tone": "Description of narrative tone",
        "plot_points": [
          {{
            "id": "plot1",
            "name": "Plot Point Name",
            "description": "Description"
          }},
          {{
            "id": "plot2",
            "name": "Another Plot Point",
            "description": "Description"
          }}
        ],
        "characters": [
          {{
            "name": "Character Name",
            "role": "Role description",
            "backstory": "Character background"
          }}
        ],
        "conflicts": [
          {{
            "type": "Conflict Type",
            "description": "Conflict description"
          }}
        ]
      }}
    }}
    ```
  expected_output: >
    A valid JSON document following the structure above that clearly defines the game's setting,
    core narrative themes, major plot points, key characters, central conflicts, and narrative
    tone. The output MUST be parseable JSON, not markdown or plain text.
  agent: "PlotMasterAgent"
  output_file: "game-config/plot_outline.json"

# Restored for Chunk 0.2 testing (all 11 tasks)
EvaluateNarrativeFoundation:
  name: "Evaluate Narrative Foundation"
  description: >
    Thoroughly evaluate the narrative foundation to ensure it provides sufficient depth, clarity,
    and direction for all subsequent development. This is a critical quality gate - subsequent
    work cannot proceed until a strong narrative foundation is established.
  expected_output: >
    A comprehensive evaluation of the narrative foundation with specific feedback for improvement.
    Include explicit approval or revision requests. Only when approved can development proceed
    to the next phase.
  agent: "NarrativeDirectorAgent"
  context:
    - "GenerateOverarchingPlot"
  dependencies:
    - "GenerateOverarchingPlot"

# Narrative structure - can only proceed after foundation approval
CreateNarrativeMap:
  name: "Develop Detailed Narrative Structure"
  description: >
    Based on the approved narrative foundation, develop a detailed narrative map that defines
    all critical paths, character arcs, decision points, and narrative progression. This
    structure will direct all subsequent content creation by specialists.

    **IMPORTANT: Output must be in valid JSON format with the following structure:**
    ```json
    {{
      "narrative_map": {{
        "start_scene": "scene_id",
        "scenes": {{
          "scene_id": {{
            "name": "Scene Name",
            "description": "Scene description",
            "connections": [
              {{
                "target": "other_scene_id",
                "condition": "optional condition",
                "description": "Connection description"
              }}
            ],
            "character_moments": [
              {{
                "character": "Character Name",
                "moment": "Character development moment"
              }}
            ],
            "decision_points": [
              {{
                "id": "decision1",
                "prompt": "Decision description",
                "options": [
                  {{"choice": "Option A", "outcome": "Outcome description"}},
                  {{"choice": "Option B", "outcome": "Outcome description"}}
                ]
              }}
            ]
          }}
        }},
        "character_arcs": [
          {{
            "character": "Character Name",
            "arc_stages": [
              {{"stage": "Beginning", "description": "Character state"}},
              {{"stage": "Development", "description": "Character growth"}}
            ]
          }}
        ]
      }}
    }}
    ```
  expected_output: >
    A valid JSON document following the structure above that clearly defines all scenes,
    connections, character moments, key decision points, and narrative progression. The output
    MUST be parseable JSON, not markdown or plain text.
  agent: "NarrativeArchitectAgent"
  context:
    - "GenerateOverarchingPlot"
    # Removed EvaluateNarrativeFoundation from context to avoid "context dependency on a future task" error
  # Restored for Chunk 0.2
  dependencies:
    - "EvaluateNarrativeFoundation"  # Execution dependency to maintain correct task order
  output_file: "game-config/narrative_map.json"

# Restored for Chunk 0.2 testing (all 11 tasks)
EvaluateNarrativeStructure:
  name: "Evaluate Narrative Structure"
  description: >
    Thoroughly evaluate the narrative structure to ensure it adequately develops the approved
    foundation into an implementable blueprint for all specialized development. This is a
    critical quality gate - specialist work cannot fully proceed until the narrative structure
    is approved.
  expected_output: >
    A detailed evaluation of the narrative structure with specific feedback. Include explicit
    approval or revision requests. Only when approved can specialist development fully proceed.
  agent: "NarrativeDirectorAgent"
  context:
    - "CreateNarrativeMap"
    - "GenerateOverarchingPlot"
  dependencies:
    - "CreateNarrativeMap"

# Specialized tasks - can only begin meaningful work after narrative structure approval
DesignArtifactsAndPuzzles:
  name: "Create Narrative-Integrated Puzzles and Artifacts"
  description: >
    Based on the approved narrative structure, design puzzles, artifacts, monsters, and NPCs
    that directly serve and enhance the established narrative. Each element must have clear
    connections to the narrative themes, advance the story in meaningful ways, and maintain
    thematic consistency.

    **IMPORTANT: Output must be in valid JSON format with the following structure:**
    ```json
    {{
      "puzzle_design": {{
        "puzzles": [
          {{
            "id": "puzzle1",
            "name": "Puzzle Name",
            "description": "Puzzle description",
            "location": "scene_id where puzzle appears",
            "narrative_purpose": "How this advances the story",
            "solution": {{
              "type": "solution type",
              "steps": ["step1", "step2"]
            }},
            "difficulty": "easy/medium/hard"
          }}
        ],
        "artifacts": [
          {{
            "id": "artifact1",
            "name": "Artifact Name",
            "description": "Artifact description",
            "location": "scene_id",
            "narrative_significance": "Story importance",
            "properties": [{{"property": "value"}}]
          }}
        ],
        "monsters": [
          {{
            "id": "monster1",
            "name": "Monster Name",
            "description": "Monster description",
            "locations": ["scene_id1", "scene_id2"],
            "narrative_role": "How it serves the story",
            "abilities": ["ability1", "ability2"]
          }}
        ],
        "npcs": [
          {{
            "id": "npc1",
            "name": "NPC Name",
            "role": "NPC role in story",
            "description": "NPC description",
            "locations": ["scene_id"],
            "dialogue_themes": ["theme1", "theme2"]
          }}
        ]
      }}
    }}
    ```
  expected_output: >
    A valid JSON document following the structure above with puzzle, artifact, monster, and NPC
    designs that are tightly integrated with the narrative. Each design must include explicit
    explanations of how it connects to and advances the established narrative. The output MUST be
    parseable JSON, not markdown or plain text.
  agent: "PuzzleSmithAgent"
  context:
    - "CreateNarrativeMap"
    - "GenerateOverarchingPlot"
    # Removed EvaluateNarrativeStructure from context to avoid "context dependency on a future task" error
  # Restored for Chunk 0.2
  dependencies:
    - "EvaluateNarrativeStructure"  # Execution dependency to maintain correct task order
  output_file: "game-config/puzzle_design.json"

# Restored for Chunk 0.2 testing (all 11 tasks)
NarrativeIntegrationCheckPuzzles:
  name: "Narrative Integration Check: Puzzles"
  description: >
    Evaluate how well the puzzles, artifacts, monsters, and NPCs integrate with and
    advance the established narrative. Ensure each element serves the narrative purpose
    defined in the structure and maintains thematic consistency.
  expected_output: >
    A detailed assessment of narrative integration for each puzzle element with specific
    feedback for improving narrative cohesion where needed.
  agent: "NarrativeDirectorAgent"
  context:
    - "DesignArtifactsAndPuzzles"
    - "CreateNarrativeMap"
  dependencies:
    - "DesignArtifactsAndPuzzles"

WriteSceneDescriptionsAndDialogue:
  name: "Write Narrative-Driven Scene Descriptions"
  description: >
    Based on the approved narrative structure, write scene descriptions and dialogue
    that bring the narrative to life. Each scene must accurately reflect its place in
    the narrative structure, advance the story appropriately, and maintain consistent
    tone and themes.

    **IMPORTANT: Output must be in valid JSON format with the following structure:**
    ```json
    {{
      "scene_texts": {{
        "scenes": {{
          "scene_id": {{
            "name": "Scene Name",
            "description": "Vivid scene description",
            "atmosphere": "Mood and tone description",
            "initial_text": "Text shown when player enters",
            "examination_texts": {{
              "object1": "Description when examining object1",
              "object2": "Description when examining object2"
            }},
            "dialogue": [
              {{
                "speaker": "Character Name",
                "text": "Dialogue text",
                "context": "When this is said"
              }},
              {{
                "speaker": "Another Character",
                "text": "Response text",
                "emotion": "emotional state"
              }}
            ],
            "narrative_notes": "How this scene advances the story"
          }}
        }}
      }}
    }}
    ```
  expected_output: >
    A valid JSON document following the structure above with scene descriptions and dialogue
    that effectively translate the narrative structure into vivid, engaging content. Each scene
    must explicitly connect to its place in the narrative structure. The output MUST be parseable
    JSON, not markdown or plain text.
  agent: "CreativeScribeAgent"
  context:
    - "CreateNarrativeMap"
    - "GenerateOverarchingPlot"
    # Removed EvaluateNarrativeStructure from context to avoid "context dependency on a future task" error
  # Restored for Chunk 0.2
  dependencies:
    - "EvaluateNarrativeFoundation"  # Execution dependency to maintain correct task order
  output_file: "game-config/scene_texts.json"

# Restored for Chunk 0.2 testing (all 11 tasks)
NarrativeIntegrationCheckScenes:
  name: "Narrative Integration Check: Scenes"
  description: >
    Evaluate how well the scene descriptions and dialogue reflect and advance the
    established narrative. Ensure the writing effectively communicates the narrative
    moments defined in the structure and maintains consistent tone and themes.
  expected_output: >
    A detailed assessment of narrative integration for each scene with specific
    feedback for improving narrative effectiveness where needed.
  agent: "NarrativeDirectorAgent"
  context:
    - "WriteSceneDescriptionsAndDialogue"
    - "CreateNarrativeMap"
  dependencies:
    - "WriteSceneDescriptionsAndDialogue"

CreateGameMechanicsPRD:
  name: "Design Narrative-Supporting Mechanics"
  description: >
    Based on the approved narrative structure, design game mechanics that directly
    support and enhance the narrative experience. Each mechanic must have a clear
    narrative purpose, enabling player engagement with the story in meaningful ways.

    **IMPORTANT: Output must be in valid JSON format with the following structure:**
    ```json
    {{
      "prd_document": {{
        "game_title": "Game Title",
        "game_systems": {{
          "movement": {{
            "description": "How players move through the game",
            "commands": ["command1", "command2"],
            "narrative_purpose": "How this supports the story"
          }},
          "inventory": {{
            "description": "Item management system",
            "capacity": 10,
            "commands": ["take", "drop", "use"],
            "narrative_purpose": "Story relevance"
          }},
          "combat": {{
            "description": "Combat system description",
            "mechanics": [
              {{
                "name": "mechanic name",
                "rules": "How it works"
              }}
            ],
            "narrative_purpose": "Story importance"
          }},
          "interaction": {{
            "description": "How players interact with world",
            "commands": ["examine", "talk", "use"]
          }}
        }},
        "game_state": {{
          "tracked_variables": [
            {{
              "variable": "variable_name",
              "purpose": "Why we track this"
            }}
          ],
          "win_conditions": [
            {{"condition": "Win condition description"}}
          ],
          "lose_conditions": [
            {{"condition": "Lose condition description"}}
          ]
        }},
        "technical_requirements": [
          {{
            "requirement": "Technical need",
            "justification": "Why this is needed"
          }}
        ]
      }}
    }}
    ```
  expected_output: >
    A valid JSON document following the structure above where each mechanic explicitly connects
    to and supports narrative elements. Include explanations of how each mechanic serves the
    narrative purpose. The output MUST be parseable JSON, not markdown or plain text.
  agent: "MechanicsGuruAgent"
  context:
    - "CreateNarrativeMap"
    - "GenerateOverarchingPlot"
    # Removed EvaluateNarrativeStructure from context to avoid "context dependency on a future task" error
  # Restored for Chunk 0.2
  dependencies:
    - "EvaluateNarrativeStructure"  # Execution dependency to maintain correct task order
  output_file: "game-config/prd_document.json"

# Restored for Chunk 0.2 testing (all 11 tasks)
NarrativeIntegrationCheckMechanics:
  name: "Narrative Integration Check: Mechanics"
  description: >
    Evaluate how well the game mechanics support and enhance the established narrative.
    Ensure each mechanic serves a clear narrative purpose and enables meaningful
    player engagement with the story elements.
  expected_output: >
    A detailed assessment of narrative integration for each game mechanic with specific
    feedback for improving narrative alignment where needed.
  agent: "NarrativeDirectorAgent"
  context:
    - "CreateGameMechanicsPRD"
    - "CreateNarrativeMap"
  dependencies:
    - "CreateGameMechanicsPRD"

# Final integration checkpoint
# Restored for Chunk 0.2 testing (all 11 tasks)
FinalNarrativeIntegration:
  name: "Final Narrative Integration"
  description: >
    Perform a comprehensive review of all game elements together to ensure they form
    a cohesive, narrative-driven whole. Identify any inconsistencies across elements
    and ensure the complete experience maintains narrative integrity throughout the
    player journey.
  expected_output: >
    A final integration report that confirms narrative cohesion across all elements.
    Include any adjustments needed to ensure the complete game experience delivers
    a consistent, engaging narrative journey.
  agent: "NarrativeDirectorAgent"
  context:
    - "NarrativeIntegrationCheckPuzzles"
    - "NarrativeIntegrationCheckScenes"
    - "NarrativeIntegrationCheckMechanics"
  dependencies:
    - "NarrativeIntegrationCheckPuzzles"
    - "NarrativeIntegrationCheckScenes"
    - "NarrativeIntegrationCheckMechanics"

# Game Engineering - Transform narrative to playable structure
TranslateNarrativeToGameStructure:
  name: "Translate Narrative to Playable Game Structure"
  description: >
    Transform the narrative map, scene texts, and puzzle designs into a complete,
    playable game structure that conforms to the game engine's technical requirements.
    This critical translation step ensures the rich narrative content becomes an
    interactive, playable experience.

    **Key Responsibilities:**
    1. **Scene Connection Translation**: Convert narrative connections into BIDIRECTIONAL exits with proper semantics
       - Extract target scenes from the connections array
       - Map connections using GRAMMATICALLY CORRECT exit names that work with "There is an exit to the [EXIT_NAME]"
       - GOOD exit names: "north", "south", "east", "west", "forward", "corridor", "airlock", "chamber", "control room"
       - BAD exit names: "proceed", "continue", "investigate" (verbs that don't work as nouns)

       **CRITICAL - Bidirectional Navigation:**
       - ALL exits must be bidirectional unless explicitly marked as one-way in narrative
       - Use directional pairs: north↔south, east↔west, up↔down, forward↔back
       - Use location pairs: "corridor"↔"hangar", "airlock"↔"main deck", etc.
       - Example: If scene A has exit "north" → scene B, then scene B MUST have exit "south" → scene A
       - Example: If scene A has exit "airlock" → scene B, then scene B MUST have exit
        "hangar" (or original location name) → scene A

       **Exit Naming Strategy:**
       - Prefer compass directions (north/south/east/west) for clear spatial relationships
       - Use location names when direction is ambiguous ("to corridor", "to bridge")
       - Maintain consistency: track which direction was used and ensure reverse exit matches
       - Only create one-way exits for: locked_exits, narrative-specific conditions, or dead ends

       - Ensure all scenes are properly connected and reachable

    2. **Game Object Extraction**: Extract items, NPCs, and events from textual descriptions
       - Parse puzzle designs for items and artifacts
       - Extract NPCs from character moments and dialogue
       - Identify key items mentioned in scene descriptions

       **Events (scene-triggered story beats):**
       - Events are for automatic story triggers that fire when entering a scene
       - Each Event MUST have: id (string), description (string, REQUIRED)
       - Optional fields: trigger_on_entry (bool), required_flag (string), one_time (bool), effects (dict)
       - Example Event: Alarm triggers when entering, NPC leaves scene, story revelation
       - **DO NOT** create events for decision points (those become exits)
       - Most scenes will have events: [] (empty array) unless specific story triggers exist

    3. **Scene Data Structure**: Create proper Scene objects with all required fields
       - id, name, description from narrative map and scene texts
       - exits dictionary mapping directions to scene IDs
       - items list with Item objects (id, name, description, takeable)
       - npcs list with NPC objects (id, name, description, dialogue)
       - events list for scene-triggered events

    4. **Decision Point Mapping**: Convert narrative decision points into branching exits (NOT events)
       - **IMPORTANT**: Decision points from narrative_map are NOT events - they are multiple exit paths
       - Map each option in a decision_point to a separate exit in the exits dictionary
       - Example: If narrative has decision_point with 2 choices → create 2 exits from that scene
       - Use locked_exits if a choice requires a condition/flag
       - DO NOT create Event objects for decision points

       **Example Decision Point Mapping:**
       Narrative: decision_point with options "Assault immediately" vs "Sneak around"
       Game Output:
       ```json
       "exits": {{
         "assault route": "scene_combat_heavy",
         "stealth route": "scene_stealth_path"
       }}
       ```

    5. **Playability Validation**: Ensure the game is completable
       - Verify all scenes are reachable from starting scene
       - Check that no dead ends exist (except designated endings)
       - Ensure critical path is completable

    **IMPORTANT: Output must be valid JSON in the game engine's format:**
    ```json
    {{
      "game": {{
        "title": "Game Title",
        "description": "Game description",
        "starting_scene": "scene_001_hangar",
        "scenes": {{
          "scene_001_hangar": {{
            "id": "scene_001_hangar",
            "name": "Hangar Bay",
            "description": "Full scene description from scene_texts",
            "exits": {{
              "north": "scene_002_corridor",
              "east": "scene_003_armory"
            }},
            "items": [
              {{
                "id": "item_key",
                "name": "Brass Key",
                "description": "An old brass key",
                "takeable": true
              }}
            ],
            "npcs": [
              {{
                "id": "npc_guard",
                "name": "Guard",
                "description": "A stern imperial guard",
                "dialogue": {{
                  "greeting": "Halt! State your business.",
                  "give_item": "Take this, you'll need it."
                }},
                "gives_item": "item_key"
              }}
            ],
            "events": [
              {{
                "id": "event_alarm",
                "description": "An alarm begins blaring as you enter",
                "trigger_on_entry": true,
                "one_time": true,
                "effects": {{}}
              }}
            ],
            "dark": false,
            "locked_exits": {{}}
          }},
          "scene_002_corridor": {{
            "id": "scene_002_corridor",
            "name": "Main Corridor",
            "description": "A long corridor stretches before you",
            "exits": {{
              "south": "scene_001_hangar",
              "west": "scene_004_chapel"
            }},
            "items": [],
            "npcs": [],
            "events": [],
            "dark": false,
            "locked_exits": {{}}
          }},
          "scene_003_armory": {{
            "id": "scene_003_armory",
            "name": "Armory",
            "description": "Weapon racks line the walls",
            "exits": {{
              "west": "scene_001_hangar"
            }},
            "items": [],
            "npcs": [],
            "events": [],
            "dark": false,
            "locked_exits": {{}}
          }}
        }},
        "global_items": {{}},
        "global_npcs": {{}},
        "endings": [
          {{
            "id": "ending_victory",
            "scene_id": "scene_final_escape",
            "name": "Victorious Escape",
            "description": "You escaped the hulk",
            "ending_type": "victory"
          }}
        ]
      }}
    }}
    ```

  expected_output: >
    A complete, valid JSON document containing a fully playable game structure. The output
    MUST pass all validation checks:
    - All scenes are reachable from the starting scene
    - All exits point to valid scenes
    - **ALL EXITS ARE BIDIRECTIONAL** - if scene A has exit "north" to scene B,
      then scene B MUST have exit "south" to scene A
    - Exit names are grammatically correct and work with "There is an exit to the [NAME]"
    - Exit names use proper directional pairs (north↔south, east↔west, up↔down, forward↔back)
    - Decision points are mapped to multiple exits (NOT to events)
    - All events have required "description" field
    - Events do NOT have "type", "prompt", or "options" fields (those are for decision points, which become exits)
    - Most scenes will have "events": [] unless there's a specific story trigger
    - No dead ends exist (except designated ending scenes)
    - All required items are present
    - The game has a clear win/lose condition
    - The JSON structure exactly matches the game engine's Scene model

    The output MUST be parseable JSON, not markdown or plain text. Include all scenes from
    the narrative map with proper exits, items extracted from puzzles, NPCs from character
    moments, and decision points mapped to game mechanics.

  agent: "GameEngineerAgent"
  context:
    - "CreateNarrativeMap"
    - "WriteSceneDescriptionsAndDialogue"
    - "DesignArtifactsAndPuzzles"
    - "CreateGameMechanicsPRD"
  dependencies:
    - "FinalNarrativeIntegration"
  output_file: "game-config/playable_game.json"
